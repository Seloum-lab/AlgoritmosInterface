<!DOCTYPE html>
<!--
Click nbfs://nbhost/SystemFileSystem/Templates/Licenses/license-default.txt to change this license
Click nbfs://nbhost/SystemFileSystem/Templates/JSP_Servlet/Html.html to edit this template
-->
<html>
    <head>
        <title>TODO supply a title</title>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.3/jquery.min.js"></script>
        <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
        <link href="Style/Dispo.css" rel="stylesheet">
    </head>
    <body>
    <div class="container">
        <div class="h1 text-center">Take an appointment</div>
        <div class="d-row d-flex align-items-center justify-content-center">
            <input type="date" id="weekPicker" class="form-control" />
        </div>
        <div class="row text-center">
            <!-- Génération des colonnes pour chaque jour de la semaine -->
            <div class="col">
                <div class="h5 col-title" data-day-index="1">Monday</div>
                <div class="d-flex flex-column align-items-center">
                    <button class="slot btn btn-availability" data-day="monday" data-day-index="1" data-slot="1">08h - 09h</button>
                    <button class="slot btn btn-availability" data-day="monday" data-day-index="1" data-slot="2">09h - 10h</button>
                    <button class="slot btn btn-availability" data-day="monday" data-day-index="1" data-slot="3">10h - 11h</button>
                    <button class="slot btn btn-availability" data-day="monday" data-day-index="1" data-slot="4">11h - 12h</button>
                    <button class="slot btn btn-availability" data-day="monday" data-day-index="1" data-slot="5">12h - 13h</button>
                    <button class="slot btn btn-availability" data-day="monday" data-day-index="1" data-slot="6">13h - 14h</button>
                    <button class="slot btn btn-availability" data-day="monday" data-day-index="1" data-slot="7">14h - 15h</button>
                    <button class="slot btn btn-availability" data-day="monday" data-day-index="1" data-slot="8">15h - 16h</button>
                    <button class="slot btn btn-availability" data-day="monday" data-day-index="1" data-slot="9">16h - 17h</button>
                    <button class="slot btn btn-availability" data-day="monday" data-day-index="1" data-slot="10">17h - 18h</button>
                    <button class="slot btn btn-availability" data-day="monday" data-day-index="1" data-slot="11">18h - 19h</button>
                    <button class="slot btn btn-availability" data-day="monday" data-day-index="1" data-slot="12">19h - 20h</button>
                </div>
            </div>
            <!-- Copiez-collez cette section pour chaque jour de la semaine et modifiez le data-day et le titre du jour -->
            <div class="col">
                <div class="h5 col-title" data-day-index="2">Tuesday</div>
                <div class="d-flex flex-column align-items-center">
                    <button class="slot btn btn-availability" data-day="tuesday" data-day-index="2" data-slot="1">08h - 09h</button>
                    <button class="slot btn btn-availability" data-day="tuesday" data-day-index="2" data-slot="2">09h - 10h</button>
                    <button class="slot btn btn-availability" data-day="tuesday" data-day-index="2" data-slot="3">10h - 11h</button>
                    <button class="slot btn btn-availability" data-day="tuesday" data-day-index="2" data-slot="4">11h - 12h</button>
                    <button class="slot btn btn-availability" data-day="tuesday" data-day-index="2" data-slot="5">12h - 13h</button>
                    <button class="slot btn btn-availability" data-day="tuesday" data-day-index="2" data-slot="6">13h - 14h</button>
                    <button class="slot btn btn-availability" data-day="tuesday" data-day-index="2" data-slot="7">14h - 15h</button>
                    <button class="slot btn btn-availability" data-day="tuesday" data-day-index="2" data-slot="8">15h - 16h</button>
                    <button class="slot btn btn-availability" data-day="tuesday" data-day-index="2" data-slot="9">16h - 17h</button>
                    <button class="slot btn btn-availability" data-day="tuesday" data-day-index="2" data-slot="10">17h - 18h</button>
                    <button class="slot btn btn-availability" data-day="tuesday" data-day-index="2" data-slot="11">18h - 19h</button>
                    <button class="slot btn btn-availability" data-day="tuesday" data-day-index="2" data-slot="12">19h - 20h</button>
                </div>
            </div>
            <div class="col">
                <div class="h5 col-title" data-day-index="3">Wednesday</div>
                <div class="d-flex flex-column align-items-center">
                    <button class="slot btn btn-availability" data-day="wednesday" data-day-index="3" data-slot="1">08h - 09h</button>
                    <button class="slot btn btn-availability" data-day="wednesday" data-day-index="3" data-slot="2">09h - 10h</button>
                    <button class="slot btn btn-availability" data-day="wednesday" data-day-index="3" data-slot="3">10h - 11h</button>
                    <button class="slot btn btn-availability" data-day="wednesday" data-day-index="3" data-slot="4">11h - 12h</button>
                    <button class="slot btn btn-availability" data-day="wednesday" data-day-index="3" data-slot="5">12h - 13h</button>
                    <button class="slot btn btn-availability" data-day="wednesday" data-day-index="3" data-slot="6">13h - 14h</button>
                    <button class="slot btn btn-availability" data-day="wednesday" data-day-index="3" data-slot="7">14h - 15h</button>
                    <button class="slot btn btn-availability" data-day="wednesday" data-day-index="3" data-slot="8">15h - 16h</button>
                    <button class="slot btn btn-availability" data-day="wednesday" data-day-index="3" data-slot="9">16h - 17h</button>
                    <button class="slot btn btn-availability" data-day="wednesday" data-day-index="3" data-slot="10">17h - 18h</button>
                    <button class="slot btn btn-availability" data-day="wednesday" data-day-index="3" data-slot="11">18h - 19h</button>
                    <button class="slot btn btn-availability" data-day="wednesday" data-day-index="3" data-slot="12">19h - 20h</button>
                </div>
            </div>
            <div class="col">
                <div class="h5 col-title" data-day-index="4">Thursday</div>
                <div class="d-flex flex-column align-items-center">
                    <button class="slot btn btn-availability" data-day="thursday" data-day-index="4" data-slot="1">08h - 09h</button>
                    <button class="slot btn btn-availability" data-day="thursday" data-day-index="4" data-slot="2">09h - 10h</button>
                    <button class="slot btn btn-availability" data-day="thursday" data-day-index="4" data-slot="3">10h - 11h</button>
                    <button class="slot btn btn-availability" data-day="thursday" data-day-index="4" data-slot="4">11h - 12h</button>
                    <button class="slot btn btn-availability" data-day="thursday" data-day-index="4" data-slot="5">12h - 13h</button>
                    <button class="slot btn btn-availability" data-day="thursday" data-day-index="4" data-slot="6">13h - 14h</button>
                    <button class="slot btn btn-availability" data-day="thursday" data-day-index="4" data-slot="7">14h - 15h</button>
                    <button class="slot btn btn-availability" data-day="thursday" data-day-index="4" data-slot="8">15h - 16h</button>
                    <button class="slot btn btn-availability" data-day="thursday" data-day-index="4" data-slot="9">16h - 17h</button>
                    <button class="slot btn btn-availability" data-day="thursday" data-day-index="4" data-slot="10">17h - 18h</button>
                    <button class="slot btn btn-availability" data-day="thursday" data-day-index="4" data-slot="11">18h - 19h</button>
                    <button class="slot btn btn-availability" data-day="thursday" data-day-index="4" data-slot="12">19h - 20h</button>
                </div>
            </div>
            <div class="col">
                <div class="h5 col-title" data-day-index="5">Friday</div>
                <div class="d-flex flex-column align-items-center">
                    <button class="slot btn btn-availability" data-day="friday" data-day-index="5" data-slot="1">08h - 09h</button>
                    <button class="slot btn btn-availability" data-day="friday" data-day-index="5" data-slot="2">09h - 10h</button>
                    <button class="slot btn btn-availability" data-day="friday" data-day-index="5" data-slot="3">10h - 11h</button>
                    <button class="slot btn btn-availability" data-day="friday" data-day-index="5" data-slot="4">11h - 12h</button>
                    <button class="slot btn btn-availability" data-day="friday" data-day-index="5" data-slot="5">12h - 13h</button>
                    <button class="slot btn btn-availability" data-day="friday" data-day-index="5" data-slot="6">13h - 14h</button>
                    <button class="slot btn btn-availability" data-day="friday" data-day-index="5" data-slot="7">14h - 15h</button>
                    <button class="slot btn btn-availability" data-day="friday" data-day-index="5" data-slot="8">15h - 16h</button>
                    <button class="slot btn btn-availability" data-day="friday" data-day-index="5" data-slot="9">16h - 17h</button>
                    <button class="slot btn btn-availability" data-day="friday" data-day-index="5" data-slot="10">17h - 18h</button>
                    <button class="slot btn btn-availability" data-day="friday" data-day-index="5" data-slot="11">18h - 19h</button>
                    <button class="slot btn btn-availability" data-day="friday" data-day-index="5" data-slot="12">19h - 20h</button>
                </div>
            </div>
            <div class="col">
                <div class="h5 col-title" data-day-index="6">Saturday</div>
                <div class="d-flex flex-column align-items-center">
                    <button class="slot btn btn-availability" data-day="saturday" data-day-index="6" data-slot="1">08h - 09h</button>
                    <button class="slot btn btn-availability" data-day="saturday" data-day-index="6" data-slot="2">09h - 10h</button>
                    <button class="slot btn btn-availability" data-day="saturday" data-day-index="6" data-slot="3">10h - 11h</button>
                    <button class="slot btn btn-availability" data-day="saturday" data-day-index="6" data-slot="4">11h - 12h</button>
                    <button class="slot btn btn-availability" data-day="saturday" data-day-index="6" data-slot="5">12h - 13h</button>
                    <button class="slot btn btn-availability" data-day="saturday" data-day-index="6" data-slot="6">13h - 14h</button>
                    <button class="slot btn btn-availability" data-day="saturday" data-day-index="6" data-slot="7">14h - 15h</button>
                    <button class="slot btn btn-availability" data-day="saturday" data-day-index="6" data-slot="8">15h - 16h</button>
                    <button class="slot btn btn-availability" data-day="saturday" data-day-index="6" data-slot="9">16h - 17h</button>
                    <button class="slot btn btn-availability" data-day="saturday" data-day-index="6" data-slot="10">17h - 18h</button>
                    <button class="slot btn btn-availability" data-day="saturday" data-day-index="6" data-slot="11">18h - 19h</button>
                    <button class="slot btn btn-availability" data-day="saturday" data-day-index="6" data-slot="12">19h - 20h</button>
                </div>
            </div>
            <div class="col">
                <div class="h5 col-title" data-day-index="7">Sunday</div>
                <div class="d-flex flex-column align-items-center">
                    <button class="slot btn btn-availability" data-day="sunday" data-day-index="7" data-slot="1">08h - 09h</button>
                    <button class="slot btn btn-availability" data-day="sunday" data-day-index="7" data-slot="2">09h - 10h</button>
                    <button class="slot btn btn-availability" data-day="sunday" data-day-index="7" data-slot="3">10h - 11h</button>
                    <button class="slot btn btn-availability" data-day="sunday" data-day-index="7" data-slot="4">11h - 12h</button>
                    <button class="slot btn btn-availability" data-day="sunday" data-day-index="7" data-slot="5">12h - 13h</button>
                    <button class="slot btn btn-availability" data-day="sunday" data-day-index="7" data-slot="6">13h - 14h</button>
                    <button class="slot btn btn-availability" data-day="sunday" data-day-index="7" data-slot="7">14h - 15h</button>
                    <button class="slot btn btn-availability" data-day="sunday" data-day-index="7" data-slot="8">15h - 16h</button>
                    <button class="slot btn btn-availability" data-day="sunday" data-day-index="7" data-slot="9">16h - 17h</button>
                    <button class="slot btn btn-availability" data-day="sunday" data-day-index="7" data-slot="10">17h - 18h</button>
                    <button class="slot btn btn-availability" data-day="sunday" data-day-index="7" data-slot="11">18h - 19h</button>
                    <button class="slot btn btn-availability" data-day="sunday" data-day-index="7" data-slot="12">19h - 20h</button>
                </div>
            </div>
        </div>
    </div>
        
    <div class="d-row d-flex align-items-center justify-content-center">
        <button class="btn btn-primary" id="reserve">Reservate</button>
    </div>






    <script>
        // Script pour basculer la disponibilité des créneaux
        $(document).ready(function() {
            $.ajax({
                url : "./ActionServlet",
                method : "POST",
                data : {
                    todo : "verifyConnexion"
                },
                dataType: 'json'
            }).done(function(response) {
                if (!response.success) {
                    $(location).attr("href", "signIn.html");
                }
            }).fail(function () {
                window.alert("Echec");
            }); 
            
            $.ajax({
                url : "./ActionServlet",
                method : "POST",
                data : {
                    todo : "verifyPostId"
                },
                dataType: 'json'
            }).done(function(response) {
                if (!response.success) {
                    $(location).attr("href", "feed.html");
                }
            }).fail(function () {
                window.alert("Echec");
            }); 
            
            $.ajax({
                url : "./ActionServlet",
                method : "GET",
                data : {
                    todo : "getActualDispo",
                    hidden : "true",
                    date : "2023-07-10",
                    id : "-1"
                },
                dataType: 'json'
            }).done(function(response) {
                $('.slot').each(function(){
                    if (response.success){
                        //Get the day and the jour of the slot
                        const day = $(this).data('day');
                        const hour = $(this).data('slot');

                        //Initialize correctly the dispo
                        if (response[day][hour]) {
                            $(this).addClass("available");
                        } else {
                            $(this).addClass("unavailable");
                        }
                    } else {
                        window.alert("Problem mais pas échec");                        
                    }
                        
                        //Make it responsive to the click
                    $(this).on('click', function() {
                        //TODO make the functions to get the periods to chosen
                    });
                });
            }).fail(function() {
                window.alert("Echec");
            });
            
            //Variables needed to test the availabilities
            var startSlot = null;
            var endSlot = null;
            var startDay = null;
            var startHour = null;
            var endHour = null;
            var endDay = null;



            $('.slot').on('click', function() {
                if (startSlot === null && $(this).hasClass("available")) {
                    //If there is no start and the start is available, define the start Date
                    startSlot = $(this);
                    startDay = startSlot.data("day-index");
                    startHour = startSlot.data("slot");
                    
                    startSlot.addClass("start");
                    
                    //Remove the reserved from all the other slots
                    $(".slot").each(function() {
                        $(this).removeClass("reserved");
                    });
                } else if (startSlot !== null && $(this).hasClass("available")){
                    //If there is already a start, then define the end
                    endSlot = $(this);
                    endDay = endSlot.data("day-index");
                    endHour = endSlot.data("slot");
                    
                    //Big block that seems complicated but actually just add the reserved class to all in between start end, also verify that the end is after the start
                    if (endDay > startDay || (endDay === startDay && endHour >= startHour)) {
                        $(".slot").each(function() {
                            if ($(this).data("day-index") > startDay && $(this).data("day-index") < endDay) {
                                if($(this).hasClass("available"))
                                    $(this).addClass("reserved");
                            } else if (($(this).data("day-index") === startDay) && ($(this).data("day-index") === endDay)){
                                if (($(this).data("slot") >= startHour) && ($(this).data("slot") <= endHour)) {
                                    if($(this).hasClass("available"))
                                        $(this).addClass("reserved");                                 
                                }
                            } else if ($(this).data("day-index") === startDay) {
                                // Vérifie si l'élément est dans la plage d'heures du jour de début
                                if ($(this).data("slot") >= startHour) {
                                    if($(this).hasClass("available"))
                                        $(this).addClass("reserved");
                                }
                            } else if ($(this).data("day-index") === endDay) {
                                // Vérifie si l'élément est dans la plage d'heures du jour de fin
                                if ($(this).data("slot") <= endHour) {
                                    if($(this).hasClass("available"))
                                        $(this).addClass("reserved");
                                }
                            }
                        });
                    } 
                    //We remake the start null
                    startSlot.removeClass("start");
                    startSlot = null;
                }
            });
            
            $(".slot").on("mouseleave", function() {
                $(".slot").each(function() {
                   $(this).removeClass("hoverreserved");
                });
            });

            $('.slot').on("mouseenter" , function() {
                if (startSlot !== null) {
                    //If the start is actuallt defined
                    
                    //We define local end (different from the global one)
                    let endSlot = $(this);
                    let endDay = endSlot.data("day-index");
                    let endHour = endSlot.data("slot");
                    
                    
                    //Big block that seems complicated but actually just add the hoverreserved class to all in between start end, also verify that the end is after the start
                    if (endDay > startDay || (endDay === startDay && endHour >= startHour)) {
                        $(".slot").each(function() {
                            if ($(this).data("day-index") > startDay && $(this).data("day-index") < endDay) {
                                if($(this).hasClass("available"))
                                    $(this).addClass("hoverreserved");
                            } else if (($(this).data("day-index") === startDay) && ($(this).data("day-index") === endDay)){
                                if (($(this).data("slot") >= startHour) && ($(this).data("slot") <= endHour)) {
                                    if($(this).hasClass("available"))
                                        $(this).addClass("hoverreserved");                                 
                                }
                            } else if ($(this).data("day-index") === startDay) {
                                // Vérifie si l'élément est dans la plage d'heures du jour de début
                                if ($(this).data("slot") >= startHour) {
                                    if($(this).hasClass("available"))
                                        $(this).addClass("hoverreserved");
                                }
                            } else if ($(this).data("day-index") === endDay) {
                                // Vérifie si l'élément est dans la plage d'heures du jour de fin
                                if ($(this).data("slot") <= endHour) {
                                    if($(this).hasClass("available"))
                                        $(this).addClass("hoverreserved");
                                }
                            }
                        });
                    }
                }
            });
            
            $("#reserve").on("click", function() {
                let duration = new Map();
                let durationObj;
                $(".slot").each(function() {
                    if ($(this).hasClass("reserved")) {
                        let day = $(this).data("day-index") - 1;
                        let hour = $(this).data("slot") - 1;
                        if (duration.get(day) === undefined) {
                            duration.set(day, [hour]);
                        } else {
                            duration.get(day).push(hour);
                        }
                        console.log(duration);
                    }
                    durationObj = Object.fromEntries(duration);
                });
                $.ajax({
                    url : "./ActionServlet",
                    method : "POST",
                    data : {
                        todo : "takeAppointment",
                        duration : JSON.stringify(durationObj),
                        date : "2023-07-10"
                    },
                    dataType: 'json'
                }).done(function(response) {
                    if (response.success) {
                        //$(location).attr("href", "index.html");
                    } else {
                        window.alert("Erreur mais pas echec");
                    }
                }).fail(function() {
                    window.alert("Echec");
                });
            });
            
            
            
            
            
            
            //Date managment
            function getWeekStart(date) {
                const day = date.getDay();
                const diff = date.getDate() - day + (day === 0 ? -6 : 1); // Ajustement pour lundi
                return new Date(date.setDate(diff));
            }

            // Met à jour la semaine affichée
            function updateWeekDays(startDate) {
                const weekDays = ["Monday\n", "Tuesday\n", "Wednesday\n", "Thursday\n", "Friday\n", "Saturday\n", "Sunday\n"];
                let tableDate = [];
                for (let i = 0; i < 7; i++) {
                    let currentDate = new Date(startDate);
                    currentDate.setDate(startDate.getDate() + i);
                    let dayLabel = currentDate.toLocaleDateString("en-GB", { day: 'numeric', month: 'numeric', year: 'numeric' });
                    tableDate.push(dayLabel);
                }
                $(".col-title").each(function() {
                    let day = $(this).data("day-index") - 1;
                    $(this).text(weekDays[day] + tableDate[day]);
                });
            }

            // Quand la date est changée
            $('#weekPicker').on('change', function() {
                const selectedDate = new Date($(this).val());
                const weekStart = getWeekStart(selectedDate);
                updateWeekDays(weekStart);
            });
            
            $("#weekPicker").attr("min", new Date().toISOString().split("T")[0]);
            
            //Initialize
            updateWeekDays(getWeekStart(new Date($("#weekPicker").val())));
            
            

        });

    </script>

    </body>
</html>
